{% extends "base.html" %}

{% block content %}
<div class="health-dashboard">
    <h1>System Health Dashboard</h1>

    <div class="status-banner status-{{ system_status.status }}">
        <div class="banner-content">
            <h2>System Status: {{ system_status.status|title }}</h2>

            <div class="status-metrics">
                <div class="metric">
                    <div class="metric-label">Node Health:</div>
                    <div class="metric-value">{{ system_status.nodes.health_percentage }}%</div>
                </div>

                <div class="metric">
                    <div class="metric-label">Chunk Health:</div>
                    <div class="metric-value">{{ system_status.chunks.health_percentage }}%</div>
                </div>

                <div class="metric">
                    <div class="metric-label">Active Nodes:</div>
                    <div class="metric-value">{{ system_status.nodes.active }} / {{ system_status.nodes.total }}</div>
                </div>

                <div class="metric">
                    <div class="metric-label">Corrupted Chunks:</div>
                    <div class="metric-value">{{ system_status.chunks.corrupt }} / {{ system_status.chunks.total }}</div>
                </div>
            </div>
        </div>
    </div>

    <div class="content-card">
        <h2>Storage Nodes Health</h2>

        <div class="hexagon-wrapper">
            <div class="nodes-hexgrid">
                {% for node in nodes %}
                <div class="hex-item">
                    <div class="hexagon {% if node.is_available and node.status == 'active' %}active{% elif node.status == 'maintenance' %}maintenance{% else %}inactive{% endif %}">
                        <div class="hex-content">
                            <div class="node-name">{{ node.name }}</div>
                            <div class="node-health">
                                {% if node.chunks.health_percentage %}
                                    {{ node.chunks.health_percentage|floatformat:"0" }}%
                                {% else %}
                                    0%
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="nodes-legend">
                <span class="legend-item">
                    <span class="legend-dot active"></span>
                    <span>{{ system_status.nodes.active }} Active</span>
                </span>

                <span class="legend-item">
                    <span class="legend-dot maintenance"></span>
                    <span>{{ maintenance_nodes_count|default:"0" }} Maintenance</span>
                </span>

                <span class="legend-item">
                    <span class="legend-dot inactive"></span>
                    <span>{{ inactive_nodes_count|default:"0" }} Inactive</span>
                </span>
            </div>
        </div>
    </div>

    <div class="content-card">
        <h2>Your Files Health</h2>

        {% if files_with_issues %}
            <div class="warning-message">
                <p>{{ files_with_issues|length }} file(s) have health issues that need attention.</p>
            </div>

            <div class="table-responsive">
                <table class="files-table">
                    <thead>
                        <tr>
                            <th>Filename</th>
                            <th>Status</th>
                            <th>Issues</th>
                            <th>Can Recover</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in files_with_issues %}
                        <tr>
                            <td>
                                <a href="{% url 'file_storage:file_details' file.id %}">{{ file.name }}</a>
                            </td>
                            <td>
                                <span class="status-badge health-{{ file.health_status }}">
                                    {{ file.health_status|title }}
                                </span>
                            </td>
                            <td>
                                {% if file.chunks.corrupt > 0 %}
                                    <span class="issue">{{ file.chunks.corrupt }} corrupt</span>
                                {% endif %}
                                {% if file.chunks.failed > 0 %}
                                    <span class="issue">{{ file.chunks.failed }} failed</span>
                                {% endif %}
                                {% if file.chunks.missing > 0 %}
                                    <span class="issue">{{ file.chunks.missing }} missing</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if file.can_recover %}
                                    <span class="status-badge health-warning">Yes</span>
                                {% else %}
                                    <span class="status-badge health-critical">No</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'file_storage:file_details' file.id %}" class="btn btn-primary">Details</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="healthy-message">All your files are healthy!</div>
        {% endif %}
    </div>
</div>

<style>
    .health-dashboard {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    h1 {
        margin-bottom: 20px;
        color: #333;
        font-size: 24px;
    }

    /* Status Banner */
    .status-banner {
        border-radius: 8px;
        margin-bottom: 30px;
        padding: 20px;
        border-left: 4px solid #f0ba15;
        background-color: #fff8e1;
    }

    .status-healthy {
        border-left-color: #28a745;
    }

    .status-warning {
        border-left-color: #f0ba15;
    }

    .status-critical {
        border-left-color: #dc3545;
    }

    .banner-content h2 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #333;
        font-size: 18px;
    }

    .status-metrics {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
    }

    .metric {
        flex: 1;
        min-width: 160px;
    }

    .metric-label {
        font-weight: bold;
        color: #555;
        font-size: 14px;
    }

    .metric-value {
        font-size: 18px;
        margin-top: 5px;
    }

    /* Content Cards */
    .content-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        padding: 20px;
        margin-bottom: 30px;
    }

    .content-card h2 {
        margin-top: 0;
        margin-bottom: 20px;
        color: #333;
        font-size: 18px;
    }

    /* Hexagon Wrapper and Distribution */
    .hexagon-wrapper {
        width: 100%;
        padding: 0 20px;
    }

    /* Hexagon Grid for Nodes */
    .nodes-hexgrid {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-evenly;
        width: 100%;
        padding: 15px 0;
        margin-bottom: 15px;
    }

    .hex-item {
        position: relative;
        display: inline-block;
        margin: 0 15px 15px;
    }

    .hexagon {
        width: 110px;
        height: 125px;
        position: relative;
        clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s, box-shadow 0.3s;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .hexagon:hover {
        transform: scale(1.08);
        z-index: 2;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }

    .hexagon.active {
        background: linear-gradient(135deg, #82d336 0%, #5aa313 100%);
    }

    .hexagon.maintenance {
        background: linear-gradient(135deg, #ffd343 0%, #e6a800 100%);
    }

    .hexagon.inactive {
        background: linear-gradient(135deg, #ff6b6b 0%, #d13030 100%);
    }

    .hex-content {
        color: white;
        text-align: center;
        padding: 5px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .node-name {
        font-weight: bold;
        font-size: 1.1rem;
        margin-bottom: 8px;
    }

    .node-health {
        font-size: 1.5rem;
        font-weight: bold;
    }

    /* Legend */
    .nodes-legend {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin: 20px 0 5px;
        text-align: center;
    }

    .legend-item {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }

    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }

    .legend-dot.active {
        background: linear-gradient(135deg, #82d336 0%, #5aa313 100%);
    }

    .legend-dot.maintenance {
        background: linear-gradient(135deg, #ffd343 0%, #e6a800 100%);
    }

    .legend-dot.inactive {
        background: linear-gradient(135deg, #ff6b6b 0%, #d13030 100%);
    }

    /* Files Health Section */
    .healthy-message {
        background-color: #d4edda;
        color: #155724;
        padding: 12px 15px;
        border-radius: 4px;
    }

    .warning-message {
        background-color: #fff3cd;
        color: #856404;
        padding: 12px 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .files-table {
        width: 100%;
        border-collapse: collapse;
    }

    .files-table th, .files-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
    }

    .files-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }

    .files-table tr:hover {
        background-color: #f5f5f5;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .health-healthy {
        background-color: #d4edda;
        color: #155724;
    }

    .health-warning {
        background-color: #fff3cd;
        color: #856404;
    }

    .health-critical {
        background-color: #f8d7da;
        color: #721c24;
    }

    .issue {
        display: inline-block;
        margin-right: 8px;
        background-color: #f8d7da;
        color: #721c24;
        padding: 3px 8px;
        border-radius: 20px;
        font-size: 0.8rem;
    }

    .btn {
        display: inline-block;
        padding: 6px 12px;
        font-weight: 500;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        border: 1px solid transparent;
        border-radius: 4px;
        text-decoration: none;
        transition: all 0.15s ease-in-out;
    }

    .btn-primary {
        color: #fff;
        background-color: #007bff;
        border-color: #007bff;
    }

    .btn-primary:hover {
        background-color: #0069d9;
        border-color: #0062cc;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .status-metrics {
            flex-direction: column;
            gap: 15px;
        }

        .metric {
            width: 100%;
        }

        .nodes-legend {
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .nodes-hexgrid {
            justify-content: center;
        }

        .hexagon {
            width: 95px;
            height: 108px;
        }

        .node-name {
            font-size: 0.95rem;
        }

        .node-health {
            font-size: 1.3rem;
        }
    }
</style>

<script>
    // Count maintenance and inactive nodes for the legend
    document.addEventListener('DOMContentLoaded', function() {
        let maintenanceCount = document.querySelectorAll('.hexagon.maintenance').length;
        let inactiveCount = document.querySelectorAll('.hexagon.inactive').length;

        // Update legend counts
        let maintenanceLegend = document.querySelector('.legend-item:nth-child(2) span:last-child');
        let inactiveLegend = document.querySelector('.legend-item:nth-child(3) span:last-child');

        if (maintenanceLegend) {
            maintenanceLegend.textContent = maintenanceCount + ' Maintenance';
        }

        if (inactiveLegend) {
            inactiveLegend.textContent = inactiveCount + ' Inactive';
        }
    });
</script>
{% endblock %}